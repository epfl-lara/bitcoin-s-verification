\documentclass{beamer}

\usepackage{listings}
\input{solidity-highlighting.tex}

\usecolortheme{beaver}
\addtobeamertemplate{footnote}{}{\vspace{4ex}}
\setbeamerfont{footnote}{size=\scriptsize}

\newcommand\blfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

\AtBeginSection
{
  \begin{frame}
    \frametitle{Table of Contents}
    \tableofcontents[currentsection]
  \end{frame}
}

\setbeamertemplate{itemize items}{\textbullet}
\setbeamertemplate{footline}[text line]{%
  \parbox{\linewidth}{\vspace*{-8pt}
    \insertshorttitle\hfill\insertshortauthor\hfill\insertframenumber
  }
}
\setbeamertemplate{navigation symbols}{}

\begin{document}

\title{Formal Verification in Scala}
% \subtitle{The Decentralized Autonomous Organization}
\author{Ramon Boss, Anna Doukmak}

\date{2019-06-13}

\frame{\titlepage}

\begin{frame}
  \frametitle{Table of Contents}
  \tableofcontents
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Formal Verification}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}
\frametitle{Stainless}
\begin{itemize}
  \item Pure Scala
  \item Pre- and Postcondition
  \item Outcome: valid, invalid, unknown
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{Example: max}
\begin{lstlisting}[language=Scala]
def max(x: Int, y: Int): Int = {
  require(0 <= x && 0 <= y)
  val d = x - y
  if (d > 0) x
  else y
} ensuring (res =>
  x <= res && y <= res && (res == x || res == y))
\end{lstlisting}
\blfootnote{\url{https://epfl-lara.github.io/stainless/tutorial.html\#warm-up-max}}
\end{frame}


\begin{frame}
\frametitle{Properties}
\begin{itemize}
  \item Bitcoin-S
  \item No Inflation Property
  \item Addition with Zero Property
\end{itemize}
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Problems Rewriting Code}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}[fragile]
\frametitle{Rewrite Code: Turning Object into Case Object}
This:
\begin{lstlisting}[language=Scala]
object Satoshis extends BaseNumbers[Satoshis] {
  val zero = Satoshis(Int64.zero)
  val one = Satoshis(Int64.one)
}
\end{lstlisting}

Becomes this:
\begin{lstlisting}[language=Scala]
case object Satoshis extends BaseNumbers[Satoshis] {
  val zero = Satoshis(Int64.zero)
  val one = Satoshis(Int64.one)
}
\end{lstlisting}
\end{frame}


\begin{frame}[fragile]
\frametitle{Rewrite Code: BigInt \&-Function to Bound Check}
This:
\begin{lstlisting}[language=Scala]
sealed abstract class Number {
  def andMask: BigInt
  def checkResult(result: BigInt): BigInt = {
    require((result & andMask) == result)
    result
  }
}  
\end{lstlisting}
Becomes this:
\begin{lstlisting}[language=Scala]
sealed abstract class Number {
  def checkResult(result: BigInt): BigInt = {
    require(
      result <= BigInt("9223372036854775807") &&
      result >= BigInt("-9223372036854775808")
    )
    result
  }
}
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{Rewrite Code: Getting Rid of Abstract Type Member}
This:
\begin{lstlisting}[language=Scala]
sealed abstract class CurrencyUnit {
  type A

  protected def underlying: A
}

sealed abstract class Satoshis extends CurrencyUnit  
\end{lstlisting}

Becomes this:
\begin{lstlisting}[language=Scala]
  ???
\end{lstlisting}
\end{frame}


% \begin{frame}[fragile]
% \frametitle{Formal Specification}
% \begin{lstlisting}[language=Scala]
%   override def +(c: CurrencyUnit): CurrencyUnit = {
%     require(c.satoshis == Satoshis.zero)
%     Satoshis(satoshis.underlying + c.satoshis.underlying)
%   } ensuring(res => res.satoshis == this.satoshis)
% \end{lstlisting}
% \end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
\frametitle{Output of Stainless}
\centering
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]{assets/final_verify_output.png}
\end{frame}

\begin{frame}
\frametitle{Lessons Learned}
\begin{itemize}
  \item Write Verifiable Code
  \item We Verified Not Original Bitcoin-S Code
\end{itemize}
\end{frame}


\end{document}
